# Disk Analysis Workshop 

## What is Disk Analysis?

Disk analysis (or **disk forensics**) is the process of examining storage devices to extract information, recover deleted data, and investigate digital activity. It's used in:
- **Digital forensics investigations** - analyzing evidence in criminal cases
- **Incident response** - understanding how a system was compromised
- **Data recovery** - retrieving lost or deleted files
- **CTF competitions** - solving forensics challenges

Think of it as investigating a computer's storage to answer questions like: "What files were here?", "What was deleted?", "What did the user do?"

---

## What is a Disk?

A **disk** is a storage medium that holds data. It can be:

### Physical Disks
- **HDD (Hard Disk Drive)** - Traditional spinning magnetic disks
- **SSD (Solid State Drive)** - Modern flash memory storage
- **USB Flash Drives** - Portable storage devices
- **SD Cards** - Memory cards used in cameras, phones, etc.

### Disk Images
A **disk image** is an exact, bit-by-bit copy of a physical disk saved as a single file. This allows forensic analysis without touching the original evidence.

---

## Types of Disk Images

| **Format** | **Extension** | **Description** |
|-----------|--------------|----------------|
| **Raw Image** | `.img`, `.dd`, `.raw` | Exact bit-by-bit copy of the disk. **No technical difference between these extensions** - just naming conventions. Most common in CTFs. |
| **EnCase** | `.E01`, `.Ex01` | Forensic format with compression, metadata, and hash verification. Industry standard. |
| **AFF** | `.aff` | Advanced Forensic Format - open source, compressed, with metadata. |
| **VMDK/VHD** | `.vmdk`, `.vhd` | Virtual machine disk formats (VMware, VirtualBox, Hyper-V). |

**In CTFs, you'll mostly see `.img`, `.dd`, or `.raw` files.**

## Mounting a Disk Image 

**Mounting** means attaching the image file as if it were a real drive, so you can browse it normally (Explorer, `ls`, etc.).  
For forensics, always mount **read-only** to avoid modifying evidence.

## Understanding Disks: Structure

To analyze a disk, you need to understand how data is organized:

```
Physical Disk / Disk Image
    â†“
Partition Table (MBR or GPT)
    â†“
Partitions (C:\, D:\, etc.)
    â†“
File System (NTFS, FAT32, ext4)
    â†“
Files and Folders
    â†“
Deleted/Hidden Data
```

### Key Components

**1. Partition Table**
- **MBR (Master Boot Record)** - Older standard, max 2TB disks
- **GPT (GUID Partition Table)** - Modern standard, larger disks

Defines where partitions start and end on the disk.

**2. Partitions**
Logical divisions of a disk. A 1TB disk might have:
- Partition 1: System (500MB)
- Partition 2: C:\ Drive (400GB)
- Partition 3: D:\ Drive (599.5GB)

**3. File System**
How the operating system organizes files:
- **NTFS** - Windows (XP and later)
- **FAT32/exFAT** - USB drives, older Windows
- **ext4** - Linux
- **APFS/HFS+** - macOS

**4. Clusters and Sectors**
- **Sector** - Smallest physical storage unit (usually 512 bytes)
- **Cluster** - Group of sectors used by the file system (4KB typical)
- **Slack Space** - Unused space in the last cluster of a file (can hide data!)

---

# Files & Magic Bytes (Short Intro)

## What is a File?

At the lowest level, a file is just a **sequence of bytes** stored on disk.  
The file extension (`.jpg`, `.txt`, `.exe`) is only a **name** that helps the OS decide how to open it â€” but extensions can be **fake**.

---

## Magic Bytes 

**Magic Bytes** are specific bytes at the **start of a file** that reveal its **real type**, no matter the extension.

Think of it like:
- **Extension = nickname** (can lie)  
- **Magic bytes = ID card** (truth)

### Common Examples

| **Type** | **Magic Bytes (Hex)** |
|---------|----------------------|
| JPEG | `FF D8 FF` |
| PNG | `89 50 4E 47` |
| PDF | `25 50 44 46` |
| ZIP | `50 4B 03 04` |
| EXE | `4D 5A` |

---

## Quick Check (Linux/macOS)

```bash
file suspicious.jpg
# Output: Zip archive data â† real type revealed 

```

---

## How Disks Are Organized

When you save a file, the operating system:
1. Finds free clusters on the disk
2. Writes the file data to those clusters
3. Updates the **file system metadata** (file name, size, location, timestamps)
4. Stores this metadata in special areas like the **MFT (Master File Table)** on NTFS

When you delete a file:
1. The file system marks the clusters as "available"
2. The file name is removed from the directory listing
3. **BUT** - the actual data remains on disk until overwritten!

This is why forensic tools can recover "deleted" files.

### NTFS Special Features

**Master File Table (MFT)**
- Database tracking every file on an NTFS volume
- Contains file names, sizes, timestamps, and cluster locations
- Even deleted files leave traces in the MFT

**Alternate Data Streams (ADS)**
- Hidden data streams attached to files
- Not visible in normal file explorers
- Often used to hide data in CTFs

**USN Journal**
- Change log tracking all file system modifications
- Records create, delete, rename operations
- Gold mine for timeline analysis

---

## What Information Can We Extract?

| **Category** | **Examples** |
|-------------|-------------|
| **Files** | Documents, images, executables, archives |
| **Deleted Files** | Files removed from Recycle Bin but still on disk |
| **Metadata** | File creation time, modification time, access time (MAC times) |
| **User Activity** | Browser history, recently opened files, USB connection logs |
| **System Artifacts** | Registry hives, event logs, prefetch files, link files (.lnk) |
| **Hidden Data** | Alternate Data Streams, data in slack space, encrypted containers |
| **Network Info** | Saved Wi-Fi passwords, VPN configs, network shares |
| **Application Data** | Installed programs, application logs, cached data |

### Windows-Specific Artifacts

| **Artifact** | **Location** | **What It Tells You** |
|-------------|-------------|----------------------|
| **Registry** | `C:\Windows\System32\config\` | System configuration, user activity, installed software |
| **Prefetch** | `C:\Windows\Prefetch\` | Programs that have been executed (last 128) |
| **Event Logs** | `C:\Windows\System32\winevt\Logs\` | System events, logons, errors |
| **LNK Files** | `C:\Users\[user]\AppData\Roaming\Microsoft\Windows\Recent\` | Recently accessed files and folders |
| **Jumplists** | `C:\Users\[user]\AppData\Roaming\Microsoft\Windows\Recent\AutomaticDestinations\` | Recently opened documents per application |
| **NTUSER.DAT** | `C:\Users\[user]\` | User-specific registry hive |
| **Browser History** | `C:\Users\[user]\AppData\Local\[Browser]\` | Web browsing activity |

---

## Why Learn Disk Analysis?

### 1. **CTF Competitions**
Forensics is one of the main CTF categories. Disk analysis challenges test your ability to find hidden flags, recover deleted files, and analyze system artifacts.

### 2. **Career Opportunities**
- **Digital Forensics Analyst** - $60k-$100k+
- **Incident Responder** - $70k-$120k+
- **Cybersecurity Investigator** - $80k-$130k+

### 3. **Real-World Skills**
- Investigate security breaches
- Recover lost data 
- Provide evidence for legal cases
- Understand how attackers operate

### 4. **Data Never Dies**
"Deleted" doesn't mean gone. Understanding disk forensics shows you that privacy and data security require more than just hitting delete.

---

## Disk Analysis in CTFs

### Common Challenge Types

**1. Deleted File Recovery**
- Flag hidden in a file that was deleted
- Use file carving tools to recover

**2. Hidden Partitions**
- Data in unallocated space or unmounted partitions
- Requires manual partition analysis

**3. Alternate Data Streams (Windows)**
- Flag hidden in NTFS ADS
- Need to check for streams with special tools

**4. Steganography**
- Flag embedded inside image or document files
- Extract files then analyze for hidden data

**5. File Signature Analysis**
- Files with wrong extensions (fake.txt is actually a .zip)
- Check magic bytes to identify real file type

**6. Windows Artifacts**
- Reconstruct user activity from registry, prefetch, or link files
- Timeline analysis to find when something happened

**7. Password/Encryption**
- Encrypted archives or containers on the disk
- Find passwords in memory, registry, or other files


---

## Essential Tools

### For Windows Disk Analysis

####  Beginner Tools

**1. Autopsy (Windows/Linux/macOS)**
- Full-featured GUI forensics platform
- Analyzes NTFS, FAT, ext4
- Timeline viewer, keyword search, file recovery
```bash
# Install on Windows: Download from sleuthkit.org/autopsy
# Install on Linux:
sudo apt install autopsy
```

**2. FTK Imager (Windows)**
- Create disk images
- Preview files and folders
- Mount images as read-only drives
- Export files and folders
- Free from Exterro (formerly AccessData)

**3. Arsenal Image Mounter (Windows)**
- Mount disk images as virtual drives
- Read-only mounting
- Supports E01, AFF, raw images
- Free tool

**4. Eric Zimmerman's Tools (Windows)**
- Suite of specialized Windows forensics tools
- Parse registry, prefetch, LNK files, jumplists
- Command-line tools with powerful analysis
- Essential for Windows artifacts

Key tools:
- `Registry Explorer` - GUI registry viewer
- `PECmd` - Prefetch parser
- `LECmd` - LNK file parser
- `JLECmd` - Jumplist parser
- `MFTECmd` - MFT parser

#### âš™ï¸ Intermediate Tools

**5. The Sleuth Kit + mmls/fls/icat (Command-line)**
```bash
mmls disk.img                    # List partitions
fls -r -o 2048 disk.img          # List files (including deleted)
icat -o 2048 disk.img 42 > file  # Extract file by inode
```

**6. PhotoRec (Cross-platform)**
- Recover deleted files through file carving
- Recognizes 300+ file types
- Text-based interface
```bash
photorec disk.img
```

**7. Bulk Extractor (Command-line)**
- Extract emails, URLs, credit cards, Bitcoin addresses
- Doesn't need to mount the image
```bash
bulk_extractor -o output/ disk.img
```

**8. NTFS Log Tracker (Windows)**
- Parses NTFS USN Journal
- Shows file system changes over time
- Free tool by Kazumichi Saito

**9. RegRipper (Windows/Linux)**
- Automated registry analysis
- Extract useful info from registry hives
- Plugin-based system

#### ðŸ”¥ Advanced Tools

**10. X-Ways Forensics (Windows)** - Professional commercial tool
**11. EnCase Forensic (Windows)** - Industry standard (expensive)
**12. Volatility** - Memory forensics (for RAM dumps)

### Tool Comparison for Windows

| **Task** | **Best Tool** |
|---------|-------------|
| Mount disk image | Arsenal Image Mounter, FTK Imager |
| Browse files visually | Autopsy, FTK Imager |
| Recover deleted files | PhotoRec, Autopsy |
| Parse Windows registry | Registry Explorer, RegRipper |
| Analyze prefetch files | PECmd (Zimmerman) |
| Parse LNK files | LECmd (Zimmerman) |
| MFT analysis | MFTECmd (Zimmerman) |
| Timeline creation | Autopsy, log2timeline/plaso |
| String search | Bulk Extractor, strings + grep |

---


## Quick Reference

### Common Commands

```bash
# Get file info
file disk.img

# List partitions
mmls disk.img

# Mount read-only (Linux)
sudo mount -o loop,ro,offset=OFFSET disk.img /mnt/analysis

# List files including deleted
fls -r -o OFFSET disk.img

# Recover deleted file by inode
icat -o OFFSET disk.img INODE > recovered_file

# Search for strings
strings disk.img | grep -i "flag"

# File carving
foremost -i disk.img -o output/
photorec disk.img

# Calculate partition offset
# offset = start_sector * 512
```

### NTFS ADS Commands (Windows)

```cmd
# List alternate data streams
dir /r file.txt

# Read ADS content
more < file.txt:hidden.txt

# Create ADS
echo secret > file.txt:hidden.txt
```

---

## Resources

### Practice Platforms
- **picoCTF** - Beginner-friendly forensics challenges
- **CyberDefenders** - Realistic blue team scenarios
- **TryHackMe** - "Disk Analysis & Autopsy" room
- **CTFtime** - Find live CTFs and read write-ups



---

**Made by AmelSK**  
